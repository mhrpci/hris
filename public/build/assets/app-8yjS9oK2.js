import{P as s,E as c}from"./pusher-DHLPHH5Z.js";var r={};window.Pusher=s;window.Echo=new c({broadcaster:"pusher",key:r.MIX_PUSHER_APP_KEY,cluster:r.MIX_PUSHER_APP_CLUSTER,forceTLS:!0});window.Echo.channel("notifications").listen("NewNotification",i=>{l(i.count),d(i.notifications),i.toast.message&&h(i.toast.title,i.toast.message,i.toast.icon)});function l(i){const t=$(".notification-counter");i>0?t.text(i).show():t.text("0").hide()}function d(i){const t=$(".notifications-dropdown-menu");i&&t.html(i)}function h(i,t,o){toastr.info(t,i,{closeButton:!0,progressBar:!0,timeOut:5e3,extendedTimeOut:2e3,positionClass:"toast-top-right",iconClass:o||"fas fa-bell"})}function u(){$.ajax({url:"/notifications/data",method:"GET",success:function(i){l(i.count),d(i.notifications)},error:function(i){console.error("Error fetching notifications:",i.responseText)}})}setInterval(u,6e4);$(document).ready(function(){u(),$(".notification-bell").on("click",function(i){i.preventDefault(),$(".notifications-dropdown-menu").toggleClass("show")}),$(document).on("click",function(i){$(i.target).closest(".notification-bell, .notifications-dropdown-menu").length||$(".notifications-dropdown-menu").removeClass("show")})});var f={};window.Pusher=s;window.Echo=new c({broadcaster:"pusher",key:f.MIX_PUSHER_APP_KEY,cluster:f.MIX_PUSHER_APP_CLUSTER,forceTLS:!0});class m{constructor(){this.notificationCount=0,this.lastTimestamp=Date.now()/1e3,this.notificationsContainer=$(".notifications-container"),this.notificationCountBadge=$(".notification-count"),this.notificationHeaderCount=$("#notification-header-count"),this.initializeListeners(),this.loadInitialNotifications(),this.setupPolling()}initializeListeners(){window.Echo.channel("notifications").listen("NewNotification",t=>{this.updateNotificationUI(t),this.playNotificationSound(),this.showToastNotification(t.toast)}),$(document).on("click",".mark-as-read",t=>{t.preventDefault();const o=$(t.currentTarget).data("id");this.markAsRead(o)}),$(".mark-all-read").on("click",t=>{t.preventDefault(),this.markAllAsRead()}),$("#notifications-dropdown-toggle").on("click",()=>{this.notificationsContainer.find(".notification-item").length===0&&this.loadInitialNotifications()})}loadInitialNotifications(){this.notificationsContainer.html(`
            <div class="loading-notifications text-center p-3">
                <div class="spinner-border text-primary" role="status">
                    <span class="sr-only">Loading...</span>
                </div>
                <p class="text-muted mt-2">Loading notifications...</p>
            </div>
        `),$.ajax({url:"/notifications/data",type:"GET",success:t=>{this.renderNotifications(t),this.updateNotificationCount(t.count),this.lastTimestamp=Math.floor(Date.now()/1e3)},error:t=>{this.notificationsContainer.html(`
                    <div class="text-center p-3">
                        <i class="fas fa-exclamation-circle text-danger fa-2x mb-3"></i>
                        <p class="text-muted">Failed to load notifications.</p>
                    </div>
                `),console.error("Error loading notifications:",t.responseText)}})}setupPolling(){setInterval(()=>{this.checkForUpdates()},3e4)}checkForUpdates(){$.ajax({url:"/notifications/check-updates",type:"POST",data:{timestamp:this.lastTimestamp,_token:$('meta[name="csrf-token"]').attr("content")},success:t=>{t.has_new&&(this.lastTimestamp=Math.floor(Date.now()/1e3))},error:t=>{console.error("Error checking for notification updates:",t.responseText)}})}updateNotificationUI(t){this.updateNotificationCount(t.count),t.notifications&&t.notifications.length>0&&(this.notificationsContainer.find(".loading-notifications").remove(),t.notifications.forEach(o=>{const n=this.createNotificationHtml(o);this.notificationsContainer.prepend(n);const e=this.notificationsContainer.find(".notification-item").first();e.addClass("notification-highlight"),setTimeout(()=>{e.removeClass("notification-highlight")},3e3)}))}createNotificationHtml(t){return`
            <a href="${t.url}" class="notification-item ${t.is_read?"":"unread"}" data-id="${t.id}">
                <div class="notification-icon ${t.icon_class}">
                    <i class="${t.icon}"></i>
                </div>
                <div class="notification-content">
                    <div class="notification-text">${t.text}</div>
                    <div class="notification-time">${t.time}</div>
                </div>
                <div class="notification-action">
                    <button class="btn btn-sm btn-link text-muted mark-as-read" data-id="${t.id}" title="Mark as read">
                        <i class="fas fa-check"></i>
                    </button>
                </div>
            </a>
        `}updateNotificationCount(t){this.notificationCount=t,this.notificationCountBadge.text(t),this.notificationHeaderCount.text(t),t>0?this.notificationCountBadge.show():this.notificationCountBadge.hide()}renderNotifications(t){this.notificationsContainer.empty(),t.notifications&&t.notifications.length>0?t.notifications.forEach(o=>{const n=this.createNotificationHtml(o);this.notificationsContainer.append(n)}):this.notificationsContainer.html(`
                <div class="text-center p-3">
                    <i class="far fa-bell-slash text-muted fa-2x mb-3"></i>
                    <p class="text-muted">No notifications yet.</p>
                </div>
            `)}markAsRead(t){$.ajax({url:"/notifications/mark-as-read",type:"POST",data:{id:t,_token:$('meta[name="csrf-token"]').attr("content")},success:o=>{o.success&&($(`.notification-item[data-id="${t}"]`).removeClass("unread"),this.updateNotificationCount(o.count))},error:o=>{console.error("Error marking notification as read:",o.responseText)}})}markAllAsRead(){$.ajax({url:"/notifications/mark-all-as-read",type:"POST",data:{_token:$('meta[name="csrf-token"]').attr("content")},success:t=>{t.success&&($(".notification-item").removeClass("unread"),this.updateNotificationCount(0),this.showToastNotification({title:"Success",message:"All notifications marked as read",icon:"fas fa-check-circle"}))},error:t=>{console.error("Error marking all notifications as read:",t.responseText)}})}playNotificationSound(){window.notificationSound||(window.notificationSound=new Audio("/sounds/notification.mp3")),window.notificationSound&&window.notificationSound.play().catch(t=>{console.log("Could not play notification sound:",t)})}showToastNotification(t){t&&Swal.fire({title:t.title,text:t.message,icon:"info",toast:!0,position:"bottom-end",showConfirmButton:!1,timer:5e3,timerProgressBar:!0})}}$(document).ready(()=>{new m});"serviceWorker"in navigator&&"PushManager"in window&&navigator.serviceWorker.register("/service-worker.js").then(function(i){return i.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:p("BEVq1eiyhw-3VzECWiQDDKDLL5b2bzmkh6Pw1AQt-k6Xv0YD5hCsTobhlH-YURsAApNZjJPIlmbUJ-g4Z0qqN2M")})}).then(function(i){console.log("User is subscribed:",i)}).catch(function(i){console.error("Subscription failed:",i)});function p(i){const t="=".repeat((4-i.length%4)%4),o=(i+t).replace(/\-/g,"+").replace(/\_/g,"/"),n=window.atob(o),e=new Uint8Array(n.length);for(let a=0;a<n.length;++a)e[a]=n.charCodeAt(a);return e}window.Pusher=s;window.Echo=new c({broadcaster:"pusher",key:"",cluster:"mt1",forceTLS:!0});window.Echo.channel("notifications").listen("NotificationsGenerated",i=>{console.log(i.notifications),w(i.notifications)});function w(i){const t=document.getElementById("notification-menu");t.innerHTML="",i.forEach(n=>{const e=document.createElement("a");e.href="#",e.classList.add("dropdown-item"),e.innerHTML=`
            <i class="mr-2 ${n.icon}"></i> ${n.text}
            <span class="float-right text-muted text-sm">${n.time}</span>
        `,t.appendChild(e)});const o=document.getElementById("notification-count");o.textContent=i.length}
